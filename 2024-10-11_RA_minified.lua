setTickRate(10)sxSetConfig(0,0,1)d_corner=addChannel("CORNER_DIST",10)addChannel("BRAKES",10)new_lap=0;current_lap=0;delta=0;target_corner=99;best_lap_time=600;distance_to_target_corner=2000;distance_to_fastest_brake_point=2000;num_corners=3;track_marker=4;track_marker_quarters=0;prev_distances={}corner_tolerance=60;for a=1,3 do table.insert(prev_distances,0)end;at_corner=false;brake_zone_distance=1000;in_brake_zone=false;brake_detected=false;passed_brake_point=false;corner_lat={}corner_lon={}brake_point_current_lap_lat={}brake_point_current_lap_lon={}brake_point_fastest_lap_lat={}brake_point_fastest_lap_lon={}brake_recorded={}for a=1,num_corners,1 do brake_recorded[a]=false;brake_point_fastest_lap_lat[a]=0;brake_point_fastest_lap_lon[a]=0;brake_point_current_lap_lat[a]=0;brake_point_current_lap_lon[a]=0 end;corner_lat[1]=43.792079;corner_lon[1]=-87.989737;corner_lat[3]=43.80177;corner_lon[3]=-87.992557;corner_lat[3]=43.80494;corner_lon[3]=-87.997522;function check_if_at_corner()for a=1,num_corners,1 do delta=distance(corner_lat[a],corner_lon[a],current_lat,current_lon)if delta<corner_tolerance and not at_corner then target_corner=a+1;at_corner=true;passed_brake_point=false;break end;if a==target_corner then distance_to_target_corner=delta;setChannel(d_corner,delta)end;if delta>=corner_tolerance then at_corner=false end end;if target_corner>num_corners then target_corner=1 end end;function update_brake_point()in_brake_zone=distance(corner_lat[target_corner],corner_lon[target_corner],current_lat,current_lon)<=brake_zone_distance;if in_brake_zone and brake_detected and not brake_recorded[target_corner]then brake_point_current_lap_lat[target_corner]=current_lat;brake_point_current_lap_lon[target_corner]=current_lon;brake_recorded[target_corner]=true end end;function update_display()local b=1000;local c=4;approaching=false;leaving=false;local d=0;local e=b/c;distance_to_fastest_brake_point=distance(brake_point_fastest_lap_lat[target_corner],brake_point_fastest_lap_lon[target_corner],current_lat,current_lon)table.insert(prev_distances,distance_to_fastest_brake_point)table.remove(prev_distances,1)if distance_to_fastest_brake_point>prev_distances[1]then leaving=true;approaching=false else approaching=true;leaving=false end;if distance_to_fastest_brake_point>b then track_marker=d;sxSetLed(0,7,0,0,0,0)end;if distance_to_fastest_brake_point<b then track_marker=math.ceil(distance_to_fastest_brake_point/b*c)distance_within_segment=(b-distance_to_fastest_brake_point)%e;track_marker_quarters=1-distance_within_segment/e else track_marker=d;sxSetLed(0,7,0,0,0,0)end;if track_marker>0 and track_marker<=c and approaching then sxSetDisplay(0,track_marker)if track_marker_quarters<.25 then local f,g,h=getColorBasedOnTrackMarker(track_marker)sxSetLed(0,3,0,0,0,0)sxSetLed(3,1,f,g,h,0)sxSetLed(4,3,0,0,0,0)elseif track_marker_quarters<=.5 then local f,g,h=getColorBasedOnTrackMarker(track_marker)sxSetLed(0,2,0,0,0,0)sxSetLed(2,3,f,g,h,0)sxSetLed(5,2,0,0,0,0)elseif track_marker_quarters<=.75 then local f,g,h=getColorBasedOnTrackMarker(track_marker)sxSetLed(0,1,0,0,0,0)sxSetLed(1,5,f,g,h,0)sxSetLed(6,1,0,0,0,0)else local f,g,h=getColorBasedOnTrackMarker(track_marker)sxSetLed(0,7,f,g,h,0)end else sxSetDisplay(0,"")end;if leaving and track_marker<2 and distance_to_fastest_brake_point<b then sxSetDisplay(0,"")sxSetLed(0,7,255,0,0,0)end end;function getColorBasedOnTrackMarker(i)if i==1 then return 255,165,0 elseif i>=2 and i<=4 then return 0,255,0 else return 0,0,0 end end;function distance(j,k,l,m)result=math.sqrt(((math.rad(m)-math.rad(k))*math.cos((math.rad(j)+math.rad(l))/2))^2+(math.rad(l)-math.rad(j))^2)*6371e3*3.28084;return result end;function check_brakes()local n=getGpio(0)or 0;brake_detected=n>=1;if n>=1 then sxSetLed(7,1,255,0,0,0)else sxSetLed(7,1,0,0,0,0)end end;function check_if_passed_start()new_lap=getLapCount()if new_lap>current_lap then for a=1,num_corners,1 do brake_recorded[a]=false end;if getLapTime()<best_lap_time then best_lap_time=getLapTime()for a=1,num_corners,1 do if(brake_point_current_lap_lat[a]~=0 or brake_point_current_lap_lat[a]~=nil)and(brake_point_current_lap_lon[a]~=0 or brake_point_current_lap_lon[a]~=nil)then brake_point_fastest_lap_lat[a]=brake_point_current_lap_lat[a]brake_point_fastest_lap_lon[a]=brake_point_current_lap_lon[a]end end end;current_lap=new_lap;for a=1,num_corners,1 do brake_point_current_lap_lat[a]=0;brake_point_current_lap_lon[a]=0 end end end;function onTick()current_lat,current_lon=getGpsPos()check_if_passed_start()check_if_at_corner()check_brakes()update_brake_point()update_display()collectgarbage()end